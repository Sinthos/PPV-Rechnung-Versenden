{% extends "base.html" %}

{% block title %}Protokoll - PPV Rechnung Versenden{% endblock %}

{% block content %}
<div class="page-header">
    <h2>ğŸ“‹ E-Mail Protokoll</h2>
    <p class="subtitle">Letzte 100 versendete E-Mails</p>
</div>

{% if message %}
<div class="alert alert-success">
    âœ… {{ message }}
</div>
{% endif %}

{% if error %}
<div class="alert alert-error">
    âŒ {{ error }}
</div>
{% endif %}

{% if logs %}
<div class="card">
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Zeitstempel</th>
                    <th>Dateiname</th>
                    <th>Rechnungsdatum</th>
                    <th>EmpfÃ¤nger</th>
                    <th>Betreff</th>
                    <th>Status</th>
                    <th>Aktion</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr class="{% if log.status == 'failed' %}row-error{% endif %}">
                    <td class="nowrap">{{ log.timestamp|format_datetime }}</td>
                    <td>{{ log.filename }}</td>
                    <td>{{ log.invoice_date or '-' }}</td>
                    <td>{{ log.recipient_email or '-' }}</td>
                    <td>{{ log.subject }}</td>
                    <td>
                        {% if log.status == 'sent' and log.error_message %}
                        <span class="badge badge-warning" title="{{ log.error_message }}">âš ï¸ Gesendet (Verschieben fehlgeschlagen)</span>
                        {% elif log.status == 'sent' %}
                        <span class="badge badge-success">âœ… Gesendet</span>
                        {% else %}
                        <span class="badge badge-error" title="{{ log.error_message or 'Unbekannter Fehler' }}">
                            âŒ Fehler
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        <form action="/logs/{{ log.id }}/resend" method="post">
                            <button type="submit" class="btn btn-small btn-secondary">ğŸ” Erneut senden</button>
                        </form>
                    </td>
                </tr>
                {% if (log.status == 'failed' and log.error_message) or (log.status == 'sent' and log.error_message) %}
                <tr class="row-error-detail">
                    <td colspan="7">
                        <div class="error-detail">
                            <strong>Hinweis:</strong> {{ log.error_message }}
                        </div>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="card">
    <div class="empty-state">
        <p>ğŸ“­ Noch keine E-Mails versendet.</p>
        <p class="hint">Sobald Rechnungen verarbeitet werden, erscheinen sie hier.</p>
    </div>
</div>
{% endif %}

<!-- Statistics -->
{% if logs %}
<div class="card">
    <h3>ğŸ“Š Statistik</h3>
    <div class="stats-grid">
        <div class="stat-box">
            <span class="stat-value">{{ logs|length }}</span>
            <span class="stat-label">EintrÃ¤ge gesamt</span>
        </div>
        <div class="stat-box stat-success">
            <span class="stat-value">{{ logs|selectattr('status', 'equalto', 'sent')|list|length }}</span>
            <span class="stat-label">Erfolgreich</span>
        </div>
        <div class="stat-box stat-error">
            <span class="stat-value">{{ logs|selectattr('status', 'equalto', 'failed')|list|length }}</span>
            <span class="stat-label">Fehlgeschlagen</span>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
