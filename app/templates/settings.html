{% extends "base.html" %}

{% block title %}Einstellungen - PPV Rechnung Versenden{% endblock %}

{% block content %}
<div class="page-header">
    <h2>âš™ï¸ Einstellungen</h2>
</div>

{% if message %}
<div class="alert alert-success">
    âœ… {{ message }}
</div>
{% endif %}

{% if error %}
<div class="alert alert-error">
    âŒ {{ error }}
</div>
{% endif %}

<!-- Connection Status -->
<div class="card">
    <h3>ğŸ”Œ Verbindungsstatus</h3>
    {% if connection_status %}
        {% if connection_status.status == 'connected' %}
        <div class="status-box status-success">
            <p><strong>âœ… Microsoft Graph API verbunden</strong></p>
            <p>Absender: {{ connection_status.sender }}</p>
        </div>
        {% else %}
        <div class="status-box status-error">
            <p><strong>âŒ Verbindungsfehler</strong></p>
            <p>{{ connection_status.message }}</p>
            <p class="hint">Bitte prÃ¼fen Sie die Umgebungsvariablen in der .env Datei.</p>
        </div>
        {% endif %}
    {% else %}
    <div class="status-box status-warning">
        <p>âš ï¸ Verbindungsstatus unbekannt</p>
    </div>
    {% endif %}
</div>

<!-- Scheduler Status -->
<div class="card">
    <h3>â° Zeitplan</h3>
    <div class="status-box">
        {% if next_run %}
        <p><strong>NÃ¤chste AusfÃ¼hrung:</strong> {{ next_run|format_datetime }}</p>
        {% else %}
        <p>âš ï¸ Scheduler nicht aktiv</p>
        {% endif %}
    </div>
    
    <form action="/run-now" method="post" class="inline-form">
        <button type="submit" class="btn btn-primary">
            ğŸš€ Jetzt ausfÃ¼hren
        </button>
        <span class="hint">Verarbeitet alle Rechnungen im Quellordner (unabhÃ¤ngig vom Datum)</span>
    </form>
</div>

<!-- Settings Form -->
<div class="card">
    <h3>ğŸ“ Ordner & Zeitplan</h3>
    
    <form action="/settings" method="post">
        <div class="form-group">
            <label for="source_folder">Quellordner (Rechnungen)</label>
            <input 
                type="text" 
                id="source_folder" 
                name="source_folder" 
                value="{{ settings.source_folder }}"
                placeholder="/Dokumente"
                required
            >
            <span class="hint">Absoluter Pfad zum Ordner mit RE-*.pdf Dateien</span>
        </div>
        
        <div class="form-group">
            <label for="target_folder">Zielordner (Versendet)</label>
            <input 
                type="text" 
                id="target_folder" 
                name="target_folder" 
                value="{{ settings.target_folder }}"
                placeholder="/Dokumente/RE - Rechnung"
                required
            >
            <span class="hint">Absoluter Pfad zum Ordner fÃ¼r versendete Rechnungen</span>
        </div>
        
        <div class="form-group">
            <label for="send_time">TÃ¤gliche Sendezeit</label>
            <input 
                type="time" 
                id="send_time" 
                name="send_time" 
                value="{{ settings.send_time }}"
                required
            >
            <span class="hint">Uhrzeit fÃ¼r die tÃ¤gliche automatische Verarbeitung (Europe/Berlin)</span>
        </div>
        
        <div class="form-group">
            <label for="email_template">E-Mail-Vorlage</label>
            <textarea 
                id="email_template" 
                name="email_template" 
                rows="8"
                required
            >{{ settings.email_template }}</textarea>
            <span class="hint">Text der E-Mail (Betreff = Dateiname ohne .pdf)</span>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-success">
                ğŸ’¾ Einstellungen speichern
            </button>
        </div>
    </form>
</div>

<!-- Info Box -->
<div class="card card-info">
    <h3>â„¹ï¸ Hinweise</h3>
    <ul>
        <li>Rechnungen werden nur versendet, wenn das <strong>Rechnungsdatum = heute</strong> ist.</li>
        <li>Die E-Mail-Adresse wird aus dem eingebetteten ZUGFeRD-XML der PDF extrahiert.</li>
        <li>Nach erfolgreichem Versand wird die PDF in den Zielordner verschoben.</li>
        <li>Bei Fehlern bleibt die PDF im Quellordner und wird beim nÃ¤chsten Lauf erneut versucht.</li>
        <li>Mit "Jetzt ausfÃ¼hren" werden alle Rechnungen versendet (unabhÃ¤ngig vom Datum).</li>
    </ul>
</div>
{% endblock %}
