{% extends "base.html" %}

{% block title %}Einstellungen - PPV Rechnung Versenden{% endblock %}

{% block content %}
<div class="page-header">
    <h2>‚öôÔ∏è Einstellungen</h2>
</div>

{% if message %}
<div class="alert alert-success">
    ‚úÖ {{ message }}
</div>
{% endif %}

{% if error %}
<div class="alert alert-error">
    ‚ùå {{ error }}
</div>
{% endif %}

<!-- Connection Status -->
<div class="card">
    <h3>üîå Verbindungsstatus</h3>
    {% if connection_status %}
        {% if connection_status.status == 'connected' %}
        <div class="status-box status-success">
            <p><strong>‚úÖ Microsoft Graph API verbunden</strong></p>
            <p>Absender: {{ connection_status.sender }}</p>
        </div>
        {% elif connection_status.status == 'not_configured' %}
        <div class="status-box status-warning">
            <p><strong>‚ö†Ô∏è Nicht konfiguriert</strong></p>
            <p>{{ connection_status.message }}</p>
            <p class="hint">Bitte konfigurieren Sie die Microsoft Graph API Zugangsdaten unten.</p>
        </div>
        {% else %}
        <div class="status-box status-error">
            <p><strong>‚ùå Verbindungsfehler</strong></p>
            <p>{{ connection_status.message }}</p>
            <p class="hint">Bitte pr√ºfen Sie die Microsoft Graph API Zugangsdaten.</p>
        </div>
        {% endif %}
    {% else %}
    <div class="status-box status-warning">
        <p>‚ö†Ô∏è Verbindungsstatus unbekannt</p>
    </div>
    {% endif %}
</div>

<!-- Scheduler Status -->
<div class="card">
    <h3>‚è∞ Zeitplan</h3>
    <div class="status-box">
        {% if next_run %}
        <p><strong>N√§chste Ausf√ºhrung:</strong> {{ next_run|format_datetime }}</p>
        {% else %}
        <p>‚ö†Ô∏è Scheduler nicht aktiv</p>
        {% endif %}
    </div>
    
    <form action="/run-now" method="post" class="inline-form">
        <button type="submit" class="btn btn-primary">
            üöÄ Jetzt ausf√ºhren
        </button>
        <span class="hint">Verarbeitet alle Rechnungen im Quellordner (unabh√§ngig vom Datum)</span>
    </form>
</div>

<!-- Invoice Preview -->
<div class="card">
    <div class="card-header-inline">
        <div>
            <h3>üìÑ Anstehende Rechnungen</h3>
            <p class="hint">Zeigt gefundene RE-*.pdf im Quellordner mit Rechnungsdatum. Aktualisiert beim Laden und alle 5 Minuten.</p>
        </div>
        <button type="button" class="btn btn-secondary" onclick="loadInvoicePreview(true)">
            üîÑ Aktualisieren
        </button>
    </div>
    <div id="invoicePreviewStatus" class="status-box" style="margin-bottom: 0.75rem;">
        Lade Vorschau...
    </div>
    <div id="invoicePreviewList" class="invoice-list">
        <div class="loading">Lade Rechnungen...</div>
    </div>
</div>

<!-- Settings Form -->
<form action="/settings" method="post" id="settingsForm">
    
    <!-- Microsoft Graph API Settings -->
    <div class="card">
        <h3>üîê E-Mail Versand (Microsoft Graph)</h3>
        <p class="hint" style="margin-bottom: 1rem;">
            Zugangsdaten f√ºr den E-Mail-Versand √ºber Microsoft 365. 
            <a href="https://portal.azure.com" target="_blank">Azure Portal √∂ffnen</a>
        </p>
        
        <div class="form-row">
            <div class="form-group">
                <label for="tenant_id">Tenant ID</label>
                <input 
                    type="text" 
                    id="tenant_id" 
                    name="tenant_id" 
                    value="{{ settings.tenant_id or '' }}"
                    placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                >
                <span class="hint">Azure AD Directory (tenant) ID</span>
            </div>
            
            <div class="form-group">
                <label for="client_id">Client ID</label>
                <input 
                    type="text" 
                    id="client_id" 
                    name="client_id" 
                    value="{{ settings.client_id or '' }}"
                    placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                >
                <span class="hint">Azure AD Application (client) ID</span>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="client_secret">Client Secret</label>
                <input 
                    type="password" 
                    id="client_secret" 
                    name="client_secret" 
                    value="{{ settings.client_secret or '' }}"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                >
                <span class="hint">Azure AD Client Secret (wird verschl√ºsselt gespeichert)</span>
            </div>
            
            <div class="form-group">
                <label for="sender_address">Absender E-Mail</label>
                <input 
                    type="email" 
                    id="sender_address" 
                    name="sender_address" 
                    value="{{ settings.sender_address or '' }}"
                    placeholder="rechnung@example.com"
                >
                <span class="hint">E-Mail-Adresse f√ºr den Versand (muss Mail.Send Berechtigung haben)</span>
            </div>
        </div>
        
        <button type="button" class="btn btn-secondary" onclick="testConnection()">
            üîç Verbindung testen
        </button>
    </div>
    
    <!-- Folder Settings -->
    <div class="card">
        <h3>üìÅ Speicher & Ordner</h3>

        <!-- Storage Type Selection -->
        <div class="form-group">
            <label>Speichertyp</label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="storage_type" value="local" 
                           {% if settings.storage_type == 'local' %}checked{% endif %}
                           onchange="toggleStorageSettings()"> 
                    Lokal (Server-Dateisystem)
                </label>
                <label class="radio-label">
                    <input type="radio" name="storage_type" value="smb" 
                           {% if settings.storage_type == 'smb' %}checked{% endif %}
                           onchange="toggleStorageSettings()"> 
                    Netzwerk (SMB/CIFS)
                </label>
            </div>
        </div>

        <!-- SMB Settings -->
        <div id="smbSettings" style="display: none; border-left: 3px solid #007bff; padding-left: 1rem; margin-bottom: 1.5rem;">
            <h4>Netzwerk-Konfiguration</h4>
            <p class="hint">Hinweis: Bitte speichern Sie die Einstellungen, bevor Sie die Ordner durchsuchen.</p>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="smb_host">Server / Host</label>
                    <input type="text" id="smb_host" name="smb_host" value="{{ settings.smb_host }}" placeholder="192.168.1.100">
                </div>
                <div class="form-group">
                    <label for="smb_share">Freigabe (Share)</label>
                    <input type="text" id="smb_share" name="smb_share" value="{{ settings.smb_share }}" placeholder="Data">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="smb_username">Benutzername</label>
                    <input type="text" id="smb_username" name="smb_username" value="{{ settings.smb_username }}">
                </div>
                <div class="form-group">
                    <label for="smb_password">Passwort</label>
                    <input type="password" id="smb_password" name="smb_password" value="{{ settings.smb_password }}" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
            </div>
             <div class="form-group">
                <label for="smb_domain">Domain (Optional)</label>
                <input type="text" id="smb_domain" name="smb_domain" value="{{ settings.smb_domain }}" placeholder="WORKGROUP">
            </div>
            
            <button type="button" class="btn btn-secondary" onclick="testSMBConnection()">
                üîç SMB Verbindung testen
            </button>
        </div>
        
        <div class="form-group">
            <label for="source_folder">Quellordner (Rechnungen)</label>
            <div class="input-with-button">
                <input 
                    type="text" 
                    id="source_folder" 
                    name="source_folder" 
                    value="{{ settings.source_folder }}"
                    placeholder="/Dokumente"
                    required
                >
                <button type="button" class="btn btn-secondary" onclick="openFolderBrowser('source_folder')">
                    üìÇ Durchsuchen
                </button>
            </div>
            <span class="hint">Absoluter Pfad zum Ordner mit RE-*.pdf Dateien</span>
        </div>
        
        <div class="form-group">
            <label for="target_folder">Zielordner (Versendet)</label>
            <div class="input-with-button">
                <input 
                    type="text" 
                    id="target_folder" 
                    name="target_folder" 
                    value="{{ settings.target_folder }}"
                    placeholder="/Dokumente/RE - Rechnung"
                    required
                >
                <button type="button" class="btn btn-secondary" onclick="openFolderBrowser('target_folder')">
                    üìÇ Durchsuchen
                </button>
            </div>
            <span class="hint">Absoluter Pfad zum Ordner f√ºr versendete Rechnungen</span>
        </div>
    </div>
    
    <!-- Schedule & Email Settings -->
    <div class="card">
        <h3>üìß Zeitplan & E-Mail</h3>
        
        <div class="form-group">
            <label for="send_time">T√§gliche Sendezeit</label>
            <input 
                type="time" 
                id="send_time" 
                name="send_time" 
                value="{{ settings.send_time }}"
                required
                style="max-width: 200px;"
            >
            <span class="hint">Uhrzeit f√ºr die t√§gliche automatische Verarbeitung (Europe/Berlin)</span>
        </div>
        
        <div class="form-group">
            <label for="email_template">E-Mail-Vorlage</label>
            <textarea 
                id="email_template" 
                name="email_template" 
                rows="8"
                required
            >{{ settings.email_template }}</textarea>
            <span class="hint">Text der E-Mail (Betreff = Dateiname ohne .pdf)</span>
        </div>
    </div>
    
    <div class="form-actions-sticky">
        <button type="submit" class="btn btn-success btn-large">
            üíæ Alle Einstellungen speichern
        </button>
    </div>
</form>

<!-- Info Box -->
<div class="card card-info">
    <h3>‚ÑπÔ∏è Hinweise</h3>
    <ul>
        <li>Rechnungen werden nur versendet, wenn das <strong>Rechnungsdatum = heute</strong> ist.</li>
        <li>Die E-Mail-Adresse wird aus dem eingebetteten ZUGFeRD-XML der PDF extrahiert.</li>
        <li>Nach erfolgreichem Versand wird die PDF in den Zielordner verschoben.</li>
        <li>Bei Fehlern bleibt die PDF im Quellordner und wird beim n√§chsten Lauf erneut versucht.</li>
        <li>Mit "Jetzt ausf√ºhren" werden alle Rechnungen versendet (unabh√§ngig vom Datum).</li>
    </ul>
</div>

<!-- Folder Browser Modal -->
<div id="folderBrowserModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üìÇ Ordner ausw√§hlen</h3>
            <button type="button" class="modal-close" onclick="closeFolderBrowser()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="folder-browser-path">
                <span id="currentPath">/</span>
            </div>
            <div class="folder-browser-actions">
                <button type="button" class="btn btn-small" onclick="navigateUp()" id="btnUp">
                    ‚¨ÜÔ∏è √úbergeordneter Ordner
                </button>
                <button type="button" class="btn btn-small btn-secondary" onclick="showCreateFolder()">
                    ‚ûï Neuer Ordner
                </button>
            </div>
            <div id="createFolderForm" style="display: none; margin: 1rem 0;">
                <div class="input-with-button">
                    <input type="text" id="newFolderName" placeholder="Neuer Ordnername">
                    <button type="button" class="btn btn-small btn-success" onclick="createFolder()">Erstellen</button>
                    <button type="button" class="btn btn-small" onclick="hideCreateFolder()">Abbrechen</button>
                </div>
            </div>
            <div id="folderList" class="folder-list">
                <div class="loading">Lade Ordner...</div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeFolderBrowser()">Abbrechen</button>
            <button type="button" class="btn btn-success" onclick="selectFolder()">Ordner ausw√§hlen</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentBrowserPath = '/';
let targetInputId = null;
let parentPath = null;
let invoicePreviewTimer = null;

function openFolderBrowser(inputId) {
    targetInputId = inputId;
    const currentValue = document.getElementById(inputId).value || '/';
    currentBrowserPath = currentValue;
    document.getElementById('folderBrowserModal').style.display = 'flex';
    loadFolderContents(currentBrowserPath);
}

function closeFolderBrowser() {
    document.getElementById('folderBrowserModal').style.display = 'none';
    targetInputId = null;
}

function loadFolderContents(path) {
    const folderList = document.getElementById('folderList');
    folderList.innerHTML = '<div class="loading">Lade Ordner...</div>';
    
    fetch(`/api/browse?path=${encodeURIComponent(path)}`)
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.detail || 'Fehler beim Laden');
                });
            }
            return response.json();
        })
        .then(data => {
            currentBrowserPath = data.current_path;
            parentPath = data.parent_path;
            document.getElementById('currentPath').textContent = data.current_path;
            document.getElementById('btnUp').disabled = !data.parent_path;
            
            if (data.directories.length === 0) {
                folderList.innerHTML = '<div class="empty-folder">Keine Unterordner vorhanden</div>';
                return;
            }
            
            folderList.innerHTML = data.directories.map(dir => `
                <div class="folder-item ${dir.access_denied ? 'disabled' : ''}" 
                     onclick="${dir.access_denied ? '' : `navigateTo('${dir.path.replace(/'/g, "\\'")}')`}">
                    <span class="folder-icon">${dir.access_denied ? 'üîí' : 'üìÅ'}</span>
                    <span class="folder-name">${dir.name}</span>
                    ${dir.has_children ? '<span class="folder-arrow">‚Ä∫</span>' : ''}
                </div>
            `).join('');
        })
        .catch(error => {
            folderList.innerHTML = `<div class="error-message">‚ùå ${error.message}</div>`;
        });
}

function navigateTo(path) {
    loadFolderContents(path);
}

function navigateUp() {
    if (parentPath) {
        loadFolderContents(parentPath);
    }
}

function selectFolder() {
    if (targetInputId) {
        document.getElementById(targetInputId).value = currentBrowserPath;
    }
    closeFolderBrowser();
}

function showCreateFolder() {
    document.getElementById('createFolderForm').style.display = 'block';
    document.getElementById('newFolderName').focus();
}

function hideCreateFolder() {
    document.getElementById('createFolderForm').style.display = 'none';
    document.getElementById('newFolderName').value = '';
}

function createFolder() {
    const folderName = document.getElementById('newFolderName').value.trim();
    if (!folderName) {
        alert('Bitte geben Sie einen Ordnernamen ein');
        return;
    }
    
    const newPath = currentBrowserPath + (currentBrowserPath.endsWith('/') ? '' : '/') + folderName;
    
    const formData = new FormData();
    formData.append('path', newPath);
    
    fetch('/api/create-folder', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.detail || 'Fehler beim Erstellen');
            });
        }
        return response.json();
    })
    .then(data => {
        hideCreateFolder();
        loadFolderContents(currentBrowserPath);
    })
    .catch(error => {
        alert('Fehler: ' + error.message);
    });
}

function testConnection() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ Teste...';
    btn.disabled = true;
    
    // First save the form, then test
    const form = document.getElementById('settingsForm');
    const formData = new FormData(form);
    
    fetch('/settings', {
        method: 'POST',
        body: formData
    })
    .then(() => {
        return fetch('/api/connection-test');
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('‚úÖ Verbindung erfolgreich!\n\nAbsender: ' + data.details.sender);
        } else {
            alert('‚ùå Verbindungsfehler:\n\n' + (data.detail || 'Unbekannter Fehler'));
        }
    })
    .catch(error => {
        alert('‚ùå Fehler:\n\n' + error.message);
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function testSMBConnection() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ Teste...';
    btn.disabled = true;

    // Get SMB fields directly
    const formData = new FormData();
    formData.append('host', document.getElementById('smb_host').value);
    formData.append('share', document.getElementById('smb_share').value);
    formData.append('username', document.getElementById('smb_username').value);
    formData.append('password', document.getElementById('smb_password').value);
    formData.append('domain', document.getElementById('smb_domain').value);

    fetch('/api/smb/test', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('‚úÖ ' + data.message);
        } else {
            alert('‚ùå ' + data.message);
        }
    })
    .catch(error => {
        alert('‚ùå Kommunikationsfehler:\n\n' + error.message);
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeFolderBrowser();
    }
});

// Close modal on backdrop click
document.getElementById('folderBrowserModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeFolderBrowser();
    }
});

function describeInvoiceStatus(item) {
    if (item.status === 'today') return 'Heute (wird gesendet)';
    if (item.status === 'future') {
        const days = item.days_until || 0;
        return days === 1 ? 'Morgen' : `In ${days} Tagen`;
    }
    if (item.status === 'past') return 'Datum in der Vergangenheit';
    if (item.status === 'no_date') return 'Kein Rechnungsdatum gefunden';
    if (item.status === 'parse_error') return 'Lesefehler (ZUGFeRD)';
    if (item.status === 'error') return item.error || 'Unbekannter Fehler';
    return 'Unbekannter Status';
}

function badgeClassForStatus(status) {
    if (status === 'today') return 'badge badge-success';
    if (status === 'future') return 'badge badge-warning';
    if (status === 'past') return 'badge badge-error';
    if (status === 'no_date' || status === 'parse_error' || status === 'error') return 'badge badge-muted';
    return 'badge';
}

function renderInvoicePreview(data) {
    const statusEl = document.getElementById('invoicePreviewStatus');
    const listEl = document.getElementById('invoicePreviewList');

    if (!data || data.status !== 'success') {
        statusEl.innerHTML = '‚ùå Vorschau nicht verf√ºgbar.';
        listEl.innerHTML = '<div class="error-message">Keine Daten geladen.</div>';
        return;
    }

    const nowText = new Date().toLocaleTimeString('de-DE');
    statusEl.innerHTML = `<strong>Quelle:</strong> ${data.source_folder || '-'} &nbsp; ‚Ä¢ &nbsp; <strong>Aktualisiert:</strong> ${nowText}`;

    if (!data.items || data.items.length === 0) {
        listEl.innerHTML = '<div class="empty-folder">Keine RE-*.pdf im Quellordner gefunden.</div>';
        return;
    }

    const rows = data.items.map(item => {
        const dueText = describeInvoiceStatus(item);
        const badgeCls = badgeClassForStatus(item.status);
        const dateText = item.invoice_date || '-';
        const recipient = item.recipient || '-';
        return `
            <div class="invoice-row">
                <div class="invoice-col name" title="${item.path || ''}">${item.filename}</div>
                <div class="invoice-col date">${dateText}</div>
                <div class="invoice-col recipient">${recipient}</div>
                <div class="invoice-col status"><span class="${badgeCls}">${dueText}</span></div>
            </div>
        `;
    }).join('');

    listEl.innerHTML = `
        <div class="invoice-header">
            <div class="invoice-col name">Datei</div>
            <div class="invoice-col date">Rechnungsdatum</div>
            <div class="invoice-col recipient">Empf√§nger</div>
            <div class="invoice-col status">F√§llig</div>
        </div>
        ${rows}
    `;
}

function loadInvoicePreview(showSpinner = false) {
    const listEl = document.getElementById('invoicePreviewList');
    if (showSpinner) {
        listEl.innerHTML = '<div class="loading">Lade Rechnungen...</div>';
    }

    fetch('/api/invoice-preview')
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.detail || 'Fehler beim Laden');
                }).catch(() => {
                    throw new Error('Fehler beim Laden');
                });
            }
            return response.json();
        })
        .then(data => renderInvoicePreview(data))
        .catch(error => {
            document.getElementById('invoicePreviewStatus').innerHTML = '‚ùå Vorschau nicht verf√ºgbar.';
            listEl.innerHTML = `<div class="error-message">‚ùå ${error.message}</div>`;
        });
}

function startInvoicePreviewAutoRefresh() {
    loadInvoicePreview(true);
    if (invoicePreviewTimer) {
        clearInterval(invoicePreviewTimer);
    }
    invoicePreviewTimer = setInterval(loadInvoicePreview, 5 * 60 * 1000); // every 5 minutes
}

function toggleStorageSettings() {
    const type = document.querySelector('input[name="storage_type"]:checked').value;
    const smbSettings = document.getElementById('smbSettings');
    if (type === 'smb') {
        smbSettings.style.display = 'block';
    } else {
        smbSettings.style.display = 'none';
    }
}

// Initial state
toggleStorageSettings();
startInvoicePreviewAutoRefresh();
</script>
{% endblock %}
